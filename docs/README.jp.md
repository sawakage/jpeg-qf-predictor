> Language / 语言 / 言語: [English](../README.md) | [中文](./README.zh.md) | [日本語](./README.ja.md)

# JPEG QF 予測（回帰）

二次元画像の JPEG 品質係数（QF, Quality Factor）を予測するための回帰モデル推論ツール。

---

## 目次 <!-- omit from toc -->

- [機能](#機能)
- [性能](#性能)
- [推論速度（実測）](#推論速度実測)
- [制限事項](#制限事項)
- [プロジェクト構成](#プロジェクト構成)
- [環境準備](#環境準備)
- [クイックスタート（単一画像モード）](#クイックスタート単一画像モード)
- [完全な使用フロー](#完全な使用フロー)
- [コマンドライン引数ヘルプ](#コマンドライン引数ヘルプ)
- [出力結果の説明（CSV / DB フィールド）](#出力結果の説明csv--db-フィールド)
- [推論フローの説明（パッチ選択ロジック）](#推論フローの説明パッチ選択ロジック)
- [スキップとエラー処理の仕組み](#スキップとエラー処理の仕組み)
- [ライセンス](#ライセンス)

---

## 機能

- ✅ 単一 JPEG 画像の推論
- ✅ フォルダ単位の一括推論
- ✅ サブディレクトリの再帰スキャンに対応
- ✅ `CSV` / `SQLite` / `CSV+SQLite` で出力
- ✅ 分離保存：
  - 推論成功結果（`predictions`）
  - スキップ/エラーサンプル（`issues`）
- ✅ TTA（テスト時拡張、反転）に対応
- ✅ checkpoint 内蔵キャリブレータ（ON/OFF 可）
- ✅ `cuda/cpu` の自動選択に対応
- ✅ ピクセル上限によるスキップ機能（超大画像の過剰なリソース消費を回避）
- ✅ カスタム拡張子フィルタ（例：`.jpg .jpeg .jfif`）
- ✅ 出力先ファイルが既に存在する場合は自動でタイムスタンプを付与（上書き防止）

---

## 性能

テストセット結果：

- **テストセットサンプル数：2763**
- **MAE（キャリブレーション後）：0.1541**
- **Acc@1（キャリブレーション後）：99.78%**
- **Acc@2（キャリブレーション後）：99.86%**
- **Acc@5（キャリブレーション後）：99.93%**

---

## 推論速度（実測）

- **平均約 3 秒 / 枚**（テストセットでの実測）
- ハードウェア（**ノート PC 環境**）：
  - **CPU**: Intel i7-12700H
  - **メモリ**: 16GB
  - **GPU**: RTX 3060 Laptop GPU

> 実際の速度は、画像サイズ、TTA の有無、ディスク I/O 速度、システム負荷などの要因で変動します。

---
## 制限事項

- JPEG または同種の圧縮画像にのみ適用可能
- QF はエンコーダ実装に依存（PIL/libjpeg/OpenCV などで差が出る可能性あり）
- 再圧縮、複数回保存、トリミング/フィルタ処理後は、QF 予測の意味合いが弱くなる

---
## プロジェクト構成

推奨リポジトリ構成（例）：

```text
.
├── infer.py
├── model.py
├── requirements.txt
├── checkpoints/
│   └── model.pth
├── demo/
│   └── test.jpg
├── outputs/
└── README.md
```

---

## 環境準備

### 1) Python 環境
Python 3.9+ を推奨します。

### 2) 依存関係のインストール（`requirements.txt` を使用）

```bash
pip install -r requirements.txt
```

> `requirements.txt` にお使いの CUDA 環境と一致する PyTorch が含まれていない場合は、先に公式手順で PyTorch をインストールしてから、上記コマンドを実行してください。

### 3) モデル重みの準備
- 推論スクリプトでは `--ckpt` で `.pth` 重みファイルを指定する必要があります。
- モデル重みはリポジトリに同梱（`checkpoints/` 配下）されており、Git LFS で管理されています。
```bash
  git lfs install
  git clone https://github.com/sawakage/jpeg-qf-predictor.git
  cd jpeg-qf-predictor
  git lfs pull
```
---

## クイックスタート（単一画像モード）

スクリプトが正常に実行できるかの確認に使えます。

```bash
python infer.py --ckpt ./checkpoints/model.pth --input ./demo/test.jpg
```

成功すると、以下のような出力（単一画像モード）が表示されます：

```text
===== 结果 / Result =====
图片 / Image: ./demo/test.jpg
最终QF / Final QF: 92.0000
[+] 成功预测CSV / Predictions CSV: ./outputs/predictions.csv
[+] 问题样本CSV / Issues CSV: ./outputs/issues.csv
[*] 设备 / Device: cuda
...
```

---

## 完全な使用フロー

以下では実際の利用シナリオに沿って詳しく説明します。

> Linux/macOS：改行継続に `\` を使用  
> Windows CMD：改行継続に `^` を使用  
> または 1 行コマンドとして記述（改行継続記号は不要）

### 1) 単一画像推論

単一画像の使い方はクイックスタートと同じです。

想定用途：
- デバイス / パス / 権限の問題をデバッグ
- 小規模な目視確認

---

### 2) フォルダ一括推論

```bash
python infer.py \
  --ckpt ./checkpoints/model.pth \
  --input ./data/images
```

デフォルト動作：
- 対象ディレクトリ内の JPEG ファイルをスキャン
- サブディレクトリは**再帰しない**

---

> 以下は追加引数です。必要に応じて上記コマンドの後ろに追加してください。

### 3) サブディレクトリを再帰スキャン

```bash
  --recursive
```

想定用途：
- データセットのディレクトリ階層が深い
- 画像がカテゴリ/ソース別フォルダで管理されている

---

### 4) 結果を CSV / SQLite / 両方で出力

スクリプトは 3 つの出力モードをサポートします：

- `csv`（デフォルト）
- `db`
- `both`

#### 4.1 CSV のみ出力（デフォルト）

```bash
  --output_mode csv
```

出力ファイル（デフォルト）：
- `./outputs/predictions.csv`
- `./outputs/issues.csv`

#### 4.2 SQLite データベースのみ出力

```bash
  --output_mode db
```

出力ファイル（デフォルト）：
- `./outputs/results.db`

#### 4.3 CSV + SQLite を同時出力

```bash
  --output_mode both \
  --pred_csv ./outputs/predictions.csv \
  --issue_csv ./outputs/issues.csv \
  --output_db ./outputs/results.db
```
**出力パス引数は任意です**
> 出力先ファイルがすでに存在する場合、スクリプトはファイル名の末尾にタイムスタンプを自動付与して上書きを回避します。

---

### 5) TTA / キャリブレータ / デバイスの制御

#### 5.1 TTA を無効化（高速化）
デフォルトでは TTA（反転拡張の集約）が有効です。速度重視の場合は無効化できます：

```bash
  --disable_tta
```

#### 5.2 キャリブレータを無効化（checkpoint に含まれる場合）

```bash
  --no_calibrator
```

#### 5.3 デバイス指定

- 自動選択（デフォルト）：`--device auto`
- CPU を強制：`--device cpu`
- CUDA を強制：`--device cuda`

`cuda` を指定しても現在の環境で使用できない場合、スクリプトはエラーで終了します（想定動作）。

---

### 6) 超大画像のピクセル数上限を設定

スクリプトは、極端に大きな画像による過剰なリソース消費を避けるため、「ピクセル上限スキップ」機能をサポートします。

#### ピクセル上限を有効化

```bash
  --enable_pixel_limit
```
デフォルトのピクセル上限：
- 178,956,970 ピクセル（Pillow のデフォルト `MAX_IMAGE_PIXELS`。バージョン差で異なる可能性あり）
#### ピクセル上限をカスタマイズ

```bash
  --enable_pixel_limit \
  --max_image_pixels 100000000
```

説明：
- これは**自動リサイズではなくスキップ機構**です
- スキップされた画像は `issues.csv` または `issues` テーブルに記録され、後処理しやすくなります

---

### 7) カスタム拡張子フィルタ

デフォルトでは以下の拡張子のみ処理します：

- `.jpg`
- `.jpeg`
- `.jpe`
- `.jfif`

処理対象を拡張または制限したい場合：

```bash
  --exts .jpg .jpeg
```

説明：
- 入力が単一ファイルの場合、拡張子が許可リストにないと即エラーになります
- 入力がディレクトリの場合、許可された拡張子のファイルのみをスキャンして処理します

---

### 8) サイレントモード（ログ出力を減らす）

結果ファイルだけが重要で、端末出力を減らしたい場合は `--quiet` を使用できます。

サイレントモードでは：
- 端末ログ出力が減る
- 複数画像モードでは通常プログレスバーを表示しない
- CSV / DB 結果は通常どおり出力される

---

## コマンドライン引数ヘルプ

以下のコマンドでスクリプトのヘルプを直接確認できます：

```bash
python infer.py --help
```
---

## 出力結果の説明（CSV / DB フィールド）

スクリプトは「推論成功」と「問題サンプル」を分けて保存するため、後続の分析・クリーニング・再実行がしやすくなっています。

### 1) 推論成功 CSV（`predictions.csv`）

フィールド：
- `path`：画像のフルパス
- `filename`：ファイル名
- `pred_qf_final`：最終予測 QF

---

### 2) 問題サンプル CSV（`issues.csv`）

フィールド：
- `path`
- `filename`
- `issue_type`：`skipped` または `error`
- `issue_message`：スキップ理由または例外メッセージ

---

### 3) SQLite データベース（`results.db`）

データベースには 2 つのテーブルが含まれます：

#### `predictions`
- `id`
- `path`
- `filename`
- `pred_qf_final`

#### `issues`
- `id`
- `path`
- `filename`
- `issue_type`
- `issue_message`

---

## 推論フローの説明（パッチ選択ロジック）

このセクションではモデル詳細には踏み込まず、実際の推論時にスクリプトが何をしているかを説明し、なぜ一部の画像がスキップされるのかを理解しやすくします。

### パッチ選別戦略

現在のスクリプトで固定されている推論パラメータ：

- パッチサイズ：`128×128`
- ストライド：`128`
- 1画像あたりで使用する最大パッチ数：`24`
- 分散しきい値：`15.0`
- 緩和しきい値：`15.0 / 1.5`

パッチ選択ロジック（優先順位）：
1. 高しきい値パッチ数 ≥ 24：高しきい値パッチ先頭 24 個を使用
2. 高しきい値パッチ数 ≥ 5：高しきい値パッチをすべて使用
3. 緩和しきい値パッチ数 ≥ 5：緩和しきい値パッチ先頭 5 個を使用
4. 緩和しきい値パッチ数 > 0：緩和しきい値パッチをすべて使用
5. それ以外：画像情報が少なすぎると判定し、スキップして `issues` に記録

### TTA（テスト時拡張）

デフォルトで有効。スクリプトは反転拡張を行って平均を取ります：
- 元画像
- 水平反転
- 垂直反転
- 水平 + 垂直反転

### 単一画像の最終結果集約

- モデルは複数パッチに対して予測値を出力
- スクリプトは画像全体の予測結果として**中央値**を使用（外れ値パッチにより頑健）

---

## スキップとエラー処理の仕組み

1 枚の画像で失敗しても、スクリプトはバッチ処理全体を中断しません。代わりに問題を `issues` に記録し、その後の画像処理を継続します。

### よくあるスキップ理由（`issue_type=skipped`）

- 画像のピクセル数が上限を超えている（ピクセル制限有効時）
- 画像サイズがパッチサイズ（`128×128`）未満
- 画像内容の情報量が少なすぎる（有効パッチを選べない）

### よくあるエラー（`issue_type=error`）

- ファイル破損 / 途中で切れたファイル / デコード失敗
- 不正または不完全な JPEG
- 重みファイルとモデル構造の不一致
- `--device cuda` を指定したが、現在の環境で CUDA が使えない
- 単一ファイル入力時に拡張子が許可リスト外（この場合は即エラーで、バッチ処理には入らない）

## ライセンス
MIT ライセンス
